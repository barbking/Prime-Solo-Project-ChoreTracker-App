myApp.controller("AdminBankController",["$http","$location","$filter","bankService",function($http,$location,$filter,bankService){console.log("in AdminBankController");var vm=this;vm.bank=[],vm.usernames=[],vm.balance=[],vm.transaction=[{value:1,text:"withdrawal"},{value:2,text:"deposit"}],$http.get("/admin").then(function(response){response.data.username?(vm.firstname=response.data.firstname,vm.userName=response.data.username,vm.loadUsernames(),vm.getBankTransactions().then(function(){vm.bank=bankService.bank,console.log(vm.bank),vm.calcBalance(),vm.totalItems=vm.bank.length})):$location.path("/home")}),vm.loadUsernames=function(){$http.get("/usernames").then(function(response){for(vm.usernames=response.data,console.log("in get user names",vm.usernames),i=0;i<=vm.usernames.length;i++)console.log("admin status",vm.usernames[i].username,vm.usernames[i].admin),vm.usernames[i].admin&&(console.log("in loop",vm.usernames[i].username),vm.usernames.splice(i,1));return console.log("loadUsernames",vm.usernames),vm.usernames})},vm.addTransaction=function(){""==vm.bank.date||""==vm.bank.username||""==vm.bank.transaction||""==vm.bank.amount?vm.message="Cannot enter a blank selection!":(data={date:vm.bank.date,username:vm.bank.username,transaction:vm.bank.transaction,amount:vm.bank.amount,comment:vm.bank.comment},console.log("data to send to db:",data),bankService.saveTransaction(data).then(function(){vm.getBankTransactions().then(function(){vm.bank=bankService.bank,console.log(vm.bank),vm.calcBalance()})}))},vm.deleteTransaction=function(index,id){swal({title:"Are you sure?",type:"warning",showCancelButton:!0,confirmButtonColor:"#DD6B55",confirmButtonText:"Yes, delete it!",closeOnConfirm:!1},function(){swal("Deleted!","Your imaginary file has been deleted.","success"),vm.bank.splice(index,1),bankService.deleteTransaction(id).then(function(response){vm.loadUsernames(),vm.getBankTransactions().then(function(){vm.bank=bankService.bank,console.log(vm.bank),vm.calcBalance(),console.log("removeUser",vm.usernames)})})})},vm.getBankTransactions=bankService.getBankTransactions,vm.calcBalance=function(){for(vm.balance=[],console.log("in calcBalance"),i=0;i<=vm.usernames.length-1;i++){var counter=0;for(j=0;j<=vm.bank.length-1;j++)vm.usernames[i].username==vm.bank[j].username&&"deposit"==vm.bank[j].transaction?counter+=parseInt(vm.bank[j].amount):vm.usernames[i].username==vm.bank[j].username&&"withdrawal"==vm.bank[j].transaction&&(counter-=parseInt(vm.bank[j].amount));var username=vm.usernames[i].username;balance=counter;var userBal={username:username,balance:balance};vm.balance.push(userBal)}return console.log("balance[]",vm.balance),vm.balance},vm.calcBalance(),vm.showUsername=function(item){if(item.username&&vm.usernames.length){var selected=$filter("filter")(vm.usernames,{username:item.username});return selected.length?selected[0].username:"Not set"}return item.username||"Not set"},vm.showTransaction=function(item){var selected=[];return item.transaction&&(selected=$filter("filter")(vm.transaction,{text:item.transaction})),selected.length?selected[0].text:"Not set"},vm.checkAmount=function(data,item_id){if("empty"===data)return"Enter an amount"},vm.checkDate=function(data,item_id){if("empty"===data)return"Enter a new date"},vm.checkComment=function(data,item_id){if("empty"===data)return"Enter a comment"},vm.logout=function(){$http.get("/user/logout").then(function(response){console.log("logged out"),$location.path("/home")})},vm.saveTransaction=function(data,id){angular.extend(data,{_id:id}),console.log("save bank data:",data),$http.post("/bank/update",data).then(function(){vm.calcBalance()})},vm.totalItems=vm.bank.length,console.log("totalItems",vm.totalItems),vm.currentPage=1,vm.setPage=function(pageNo){vm.currentPage=pageNo},vm.maxSize=5}]);